#!/bin/bash

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç V√©rification du chiffrement SOPS des fichiers secrets...${NC}"

# V√©rifier si SOPS est install√©
if ! command -v sops &> /dev/null; then
    echo -e "${RED}‚ùå ERREUR: SOPS n'est pas install√©!${NC}"
    echo -e "${YELLOW}Installez SOPS: https://github.com/mozilla/sops${NC}"
    exit 1
fi

# R√©cup√©rer tous les fichiers *.secrets.yaml qui sont stag√©s
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.secrets\.yaml$')

if [ -z "$FILES" ]; then
    echo -e "${GREEN}‚úÖ Aucun fichier secrets √† v√©rifier${NC}"
    exit 0
fi

# Variables pour tracker
HAS_ERROR=0
UNENCRYPTED_FILES=()
ENCRYPTED_FILES=()

# V√©rifier chaque fichier
for FILE in $FILES; do
    if [ -f "$FILE" ]; then
        if grep -q "sops:" "$FILE" && grep -q "version:" "$FILE"; then
            echo -e "${GREEN}‚úÖ $FILE est d√©j√† chiffr√© avec SOPS${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è $FILE n'est PAS chiffr√©${NC}"
            UNENCRYPTED_FILES+=("$FILE")
        fi
    fi
done

# Si des fichiers non chiffr√©s sont d√©tect√©s
if [ ${#UNENCRYPTED_FILES[@]} -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}Les fichiers suivants ne sont pas chiffr√©s:${NC}"
    for FILE in "${UNENCRYPTED_FILES[@]}"; do
        echo -e "  - $FILE"
    done
    echo ""

    # Demander confirmation (avec timeout de 10 secondes)
    exec < /dev/tty
    read -t 10 -p "Voulez-vous les chiffrer automatiquement ? (O/n) " -n 1 -r REPLY
    echo ""

    # Si r√©ponse positive
    if [[ $REPLY =~ ^[Oo]$ ]]; then
        for FILE in "${UNENCRYPTED_FILES[@]}"; do
            echo -e "${BLUE}üîê Chiffrement de $FILE...${NC}"

            if sops --encrypt --in-place "$FILE" 2>/dev/null; then
                echo -e "${GREEN}‚úÖ $FILE a √©t√© chiffr√© avec succ√®s${NC}"
                git add "$FILE"
                echo -e "${GREEN}‚úÖ $FILE a √©t√© re-stag√©${NC}"
                ENCRYPTED_FILES+=("$FILE")
            else
                echo -e "${RED}‚úó ERREUR: Impossible de chiffrer $FILE${NC}"
                HAS_ERROR=1
            fi
        done
    else
        echo -e "${RED}‚ùå COMMIT REFUS√â: Fichiers non chiffr√©s d√©tect√©s${NC}"
        exit 1
    fi
fi

# Afficher un r√©sum√©
if [ ${#ENCRYPTED_FILES[@]} -gt 0 ]; then
    echo ""
    echo -e "${BLUE}üìù Fichiers chiffr√©s automatiquement:${NC}"
    for FILE in "${ENCRYPTED_FILES[@]}"; do
        echo -e "  ${GREEN}‚úÖ${NC} $FILE"
    done
fi

if [ $HAS_ERROR -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå COMMIT REFUS√â: Erreurs de chiffrement${NC}"
    echo -e "${YELLOW}V√©rifiez votre configuration SOPS (.sops.yaml)${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ Tous les fichiers secrets sont correctement chiffr√©s${NC}"
exit 0